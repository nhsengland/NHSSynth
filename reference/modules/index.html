
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../common/io/">
      
      
        <link rel="next" href="dataloader/">
      
      <link rel="icon" href="../../assets/NHS.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.5">
    
    
      
        <title>modules - Generating Useful Synthetic Data</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7a7fce14.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#nhssynth.modules" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Generating Useful Synthetic Data" class="md-header__button md-logo" aria-label="Generating Useful Synthetic Data" data-md-component="logo">
      
  <img src="../../assets/NHS.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Generating Useful Synthetic Data
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              modules
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="light-blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/nhsx/NHSSynth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nhsx/NHSSynth
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  <li class="md-tabs__item">
    <a href="../../model_card/" class="md-tabs__link">
      Model Card
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../cli/" class="md-tabs__link md-tabs__link--active">
        Code Reference
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Generating Useful Synthetic Data" class="md-nav__button md-logo" aria-label="Generating Useful Synthetic Data" data-md-component="logo">
      
  <img src="../../assets/NHS.svg" alt="logo">

    </a>
    Generating Useful Synthetic Data
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nhsx/NHSSynth" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    nhsx/NHSSynth
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../model_card/" class="md-nav__link">
        Model Card
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          Code Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Code Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../cli/">cli</a>
          
            <label for="__nav_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_1">
          <span class="md-nav__icon md-icon"></span>
          cli
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/config/" class="md-nav__link">
        config
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/module_arguments/" class="md-nav__link">
        module_arguments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/module_setup/" class="md-nav__link">
        module_setup
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../cli/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../common/">common</a>
          
            <label for="__nav_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          common
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/common/" class="md-nav__link">
        common
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/constants/" class="md-nav__link">
        constants
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/dicts/" class="md-nav__link">
        dicts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common/io/" class="md-nav__link">
        io
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index md-nav__link--active">
          <a href="./">modules</a>
          
            <label for="__nav_3_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          modules
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_1" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="dataloader/">dataloader</a>
          
            <label for="__nav_3_3_1">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_1_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3_1">
          <span class="md-nav__icon md-icon"></span>
          dataloader
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dataloader/io/" class="md-nav__link">
        io
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dataloader/metadata/" class="md-nav__link">
        metadata
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dataloader/metatransformer/" class="md-nav__link">
        metatransformer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="dataloader/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_2" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="evaluation/">evaluation</a>
          
            <label for="__nav_3_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3_2">
          <span class="md-nav__icon md-icon"></span>
          evaluation
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="evaluation/metrics/" class="md-nav__link">
        metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="evaluation/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_3" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="model/">model</a>
          
            <label for="__nav_3_3_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3_3">
          <span class="md-nav__icon md-icon"></span>
          model
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="model/DPVAE/" class="md-nav__link">
        DPVAE
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="model/io/" class="md-nav__link">
        io
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="model/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_4" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="plotting/">plotting</a>
          
            <label for="__nav_3_3_4">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3_4">
          <span class="md-nav__icon md-icon"></span>
          plotting
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="plotting/plot/" class="md-nav__link">
        plot
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="plotting/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_5" >
      
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="structure/">structure</a>
          
            <label for="__nav_3_3_5">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3_3_5">
          <span class="md-nav__icon md-icon"></span>
          structure
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="structure/run/" class="md-nav__link">
        run
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/nhsx/NHSSynth/edit/main/src/nhssynth/modules/__init__.py" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/nhsx/NHSSynth/raw/main/src/nhssynth/modules/__init__.py" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0 8a5 5 0 0 1-5-5 5 5 0 0 1 5-5 5 5 0 0 1 5 5 5 5 0 0 1-5 5m0-12.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5Z"/></svg>
    </a>
  


  <h1>modules</h1>

<div class="doc doc-object doc-module">

<a id="nhssynth.modules"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h2 id="nhssynth.modules.dataloader" class="doc doc-heading">
        <code>dataloader</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.dataloader.io" class="doc doc-heading">
        <code>io</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.io.check_input_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_input_paths</span><span class="p">(</span><span class="n">fn_input</span><span class="p">,</span> <span class="n">fn_metadata</span><span class="p">,</span> <span class="n">dir_data</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Formats the input filenames and directory for an experiment.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>fn_input</code></td>
        <td><code>str</code></td>
        <td><p>The input data filename.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_metadata</code></td>
        <td><code>str</code></td>
        <td><p>The metadata filename / suffix to append to <code>fn_input</code>.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_data</code></td>
        <td><code>str</code></td>
        <td><p>The directory that should contain both of the above.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>A tuple containing the correct directory path, input data filename and metadata filename (used for both in and out).</p></td>
    </tr>
  </tbody>
</table>      <p>!!! warnings
    Raises a UserWarning when the path to <code>fn_input</code> includes directory separators, as this is not supported and may not work as intended.
    Raises a UserWarning when the path to <code>fn_metadata</code> includes directory separators, as this is not supported and may not work as intended.</p>

        <details class="quote">
          <summary>Source code in <code>modules/dataloader/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_input_paths</span><span class="p">(</span>
    <span class="n">fn_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fn_metadata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dir_data</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the input filenames and directory for an experiment.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn_input: The input data filename.</span>
<span class="sd">        fn_metadata: The metadata filename / suffix to append to `fn_input`.</span>
<span class="sd">        dir_data: The directory that should contain both of the above.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the correct directory path, input data filename and metadata filename (used for both in and out).</span>

<span class="sd">    Warnings:</span>
<span class="sd">        Raises a UserWarning when the path to `fn_input` includes directory separators, as this is not supported and may not work as intended.</span>
<span class="sd">        Raises a UserWarning when the path to `fn_metadata` includes directory separators, as this is not supported and may not work as intended.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn_input</span><span class="p">,</span> <span class="n">fn_metadata</span> <span class="o">=</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_input</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_metadata</span><span class="p">,</span> <span class="s2">&quot;.yaml&quot;</span><span class="p">)</span>
    <span class="n">dir_data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_data</span><span class="p">)</span>
    <span class="n">fn_metadata</span> <span class="o">=</span> <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_metadata</span><span class="p">,</span> <span class="n">fn_input</span><span class="p">)</span>
    <span class="n">warn_if_path_supplied</span><span class="p">([</span><span class="n">fn_input</span><span class="p">,</span> <span class="n">fn_metadata</span><span class="p">],</span> <span class="n">dir_data</span><span class="p">)</span>
    <span class="n">check_exists</span><span class="p">([</span><span class="n">fn_input</span><span class="p">],</span> <span class="n">dir_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dir_data</span><span class="p">,</span> <span class="n">fn_input</span><span class="p">,</span> <span class="n">fn_metadata</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.io.check_output_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_output_paths</span><span class="p">(</span><span class="n">fn_input</span><span class="p">,</span> <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Formats the output filenames for an experiment.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>fn_input</code></td>
        <td><code>str</code></td>
        <td><p>The input data filename.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_output</code></td>
        <td><code>str</code></td>
        <td><p>The output data filename/suffix to append to <code>fn_input</code>.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_transformer</code></td>
        <td><code>str</code></td>
        <td><p>The transformer filename/suffix to append to <code>fn_input</code>.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_experiment</code></td>
        <td><code>Path</code></td>
        <td><p>The experiment directory to write the outputs to.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>A tuple containing the formatted output filenames.</p></td>
    </tr>
  </tbody>
</table>      <p>!!! warnings
    Raises a UserWarning when the path to <code>fn_output</code> includes directory separators, as this is not supported and may not work as intended.
    Raises a UserWarning when the path to <code>fn_transformer</code> includes directory separators, as this is not supported and may not work as intended.</p>

        <details class="quote">
          <summary>Source code in <code>modules/dataloader/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_output_paths</span><span class="p">(</span>
    <span class="n">fn_input</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fn_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fn_transformer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dir_experiment</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Formats the output filenames for an experiment.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn_input: The input data filename.</span>
<span class="sd">        fn_output: The output data filename/suffix to append to `fn_input`.</span>
<span class="sd">        fn_transformer: The transformer filename/suffix to append to `fn_input`.</span>
<span class="sd">        dir_experiment: The experiment directory to write the outputs to.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the formatted output filenames.</span>

<span class="sd">    Warnings:</span>
<span class="sd">        Raises a UserWarning when the path to `fn_output` includes directory separators, as this is not supported and may not work as intended.</span>
<span class="sd">        Raises a UserWarning when the path to `fn_transformer` includes directory separators, as this is not supported and may not work as intended.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span> <span class="o">=</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_output</span><span class="p">),</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_transformer</span><span class="p">)</span>
    <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span> <span class="o">=</span> <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_input</span><span class="p">),</span> <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_transformer</span><span class="p">,</span> <span class="n">fn_input</span><span class="p">)</span>
    <span class="n">warn_if_path_supplied</span><span class="p">([</span><span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span><span class="p">],</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.io.write_data_outputs" class="doc doc-heading">
<code class="highlight language-python"><span class="n">write_data_outputs</span><span class="p">(</span><span class="n">transformed_input</span><span class="p">,</span> <span class="n">metatransformer</span><span class="p">,</span> <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_transformer</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Writes the transformed data and metatransformer to disk.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>transformed_input</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The prepared version of the input data.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>metatransformer</code></td>
        <td><code>MetaTransformer</code></td>
        <td><p>The metatransformer used to transform the data into its prepared state.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_output</code></td>
        <td><code>str</code></td>
        <td><p>The filename to dump the prepared data to.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_transformer</code></td>
        <td><code>str</code></td>
        <td><p>The filename to dump the metatransformer to.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_experiment</code></td>
        <td><code>Path</code></td>
        <td><p>The experiment directory to write the outputs to.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">write_data_outputs</span><span class="p">(</span>
    <span class="n">transformed_input</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">metatransformer</span><span class="p">:</span> <span class="n">MetaTransformer</span><span class="p">,</span>
    <span class="n">fn_output</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">fn_transformer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">dir_experiment</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes the transformed data and metatransformer to disk.</span>

<span class="sd">    Args:</span>
<span class="sd">        transformed_input: The prepared version of the input data.</span>
<span class="sd">        metatransformer: The metatransformer used to transform the data into its prepared state.</span>
<span class="sd">        fn_output: The filename to dump the prepared data to.</span>
<span class="sd">        fn_transformer: The filename to dump the metatransformer to.</span>
<span class="sd">        dir_experiment: The experiment directory to write the outputs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformed_input</span><span class="o">.</span><span class="n">to_pickle</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_output</span><span class="p">)</span>
    <span class="n">transformed_input</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="p">(</span><span class="n">fn_output</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;csv&quot;</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_transformer</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">metatransformer</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.dataloader.metadata" class="doc doc-heading">
        <code>metadata</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metadata.check_metadata_columns" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_metadata_columns</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Check if all column representations in the <code>metadata</code> correspond to valid columns in the <code>data</code>.
If any columns are not present, add them to the metadata and instantiate an empty dictionary.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>metadata</code></td>
        <td><code>dict</code></td>
        <td><p>A dictionary containing metadata for the columns in the passed <code>data</code>.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The DataFrame to check against the metadata.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>AssertionError</code></td>
        <td><p>If any columns that <em>are</em> in metadata are <em>not</em> present in the <code>data</code>.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metadata.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_metadata_columns</span><span class="p">(</span><span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if all column representations in the `metadata` correspond to valid columns in the `data`.</span>
<span class="sd">    If any columns are not present, add them to the metadata and instantiate an empty dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata: A dictionary containing metadata for the columns in the passed `data`.</span>
<span class="sd">        data: The DataFrame to check against the metadata.</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If any columns that *are* in metadata are *not* present in the `data`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">k</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">keys</span><span class="p">()])</span>
    <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cn</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">})</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metadata.collapse" class="doc doc-heading">
<code class="highlight language-python"><span class="n">collapse</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Given a metadata dictionary, rewrite to collapse duplicate column types and transformers in order to leverage YAML anchors</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>metadata</code></td>
        <td><code>dict</code></td>
        <td><p>The metadata dictionary to be rewritten.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A rewritten metadata dictionary with collapsed column types and transformers.
    The returned dictionary has the following structure:
    {
        "transformers": dict,
        "column_types": dict,
        <strong>metadata  # one entry for each column that now reference the dicts above
    }
    - "transformers" is a dictionary mapping transformer indices to transformer configurations.
    - "column_types" is a dictionary mapping column type indices to column type configurations.
    - "</strong>metadata" contains the original metadata dictionary, with column types and transformers
      rewritten to use the indices in "transformers" and "column_types".</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metadata.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">collapse</span><span class="p">(</span><span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a metadata dictionary, rewrite to collapse duplicate column types and transformers in order to leverage YAML anchors</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata: The metadata dictionary to be rewritten.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: A rewritten metadata dictionary with collapsed column types and transformers.</span>
<span class="sd">            The returned dictionary has the following structure:</span>
<span class="sd">            {</span>
<span class="sd">                &quot;transformers&quot;: dict,</span>
<span class="sd">                &quot;column_types&quot;: dict,</span>
<span class="sd">                **metadata  # one entry for each column that now reference the dicts above</span>
<span class="sd">            }</span>
<span class="sd">            - &quot;transformers&quot; is a dictionary mapping transformer indices to transformer configurations.</span>
<span class="sd">            - &quot;column_types&quot; is a dictionary mapping column type indices to column type configurations.</span>
<span class="sd">            - &quot;**metadata&quot; contains the original metadata dictionary, with column types and transformers</span>
<span class="sd">              rewritten to use the indices in &quot;transformers&quot; and &quot;column_types&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">c_index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">column_types</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">t_index</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">transformers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">cd</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">column_types</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">column_types</span><span class="p">[</span><span class="n">c_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_types</span><span class="p">[</span><span class="n">c_index</span><span class="p">]</span>
            <span class="n">c_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cix</span> <span class="o">=</span> <span class="n">get_key_by_value</span><span class="p">(</span><span class="n">column_types</span><span class="p">,</span> <span class="n">cd</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_types</span><span class="p">[</span><span class="n">cix</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">transformers</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="ow">and</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]:</span>
            <span class="n">transformers</span><span class="p">[</span><span class="n">t_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">cn</span><span class="p">][</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="n">t_index</span><span class="p">]</span>
            <span class="n">t_index</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]:</span>
            <span class="n">tix</span> <span class="o">=</span> <span class="n">get_key_by_value</span><span class="p">(</span><span class="n">transformers</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">])</span>
            <span class="n">metadata</span><span class="p">[</span><span class="n">cn</span><span class="p">][</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformers</span><span class="p">[</span><span class="n">tix</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;transformers&quot;</span><span class="p">:</span> <span class="n">transformers</span><span class="p">,</span> <span class="s2">&quot;column_types&quot;</span><span class="p">:</span> <span class="n">column_types</span><span class="p">,</span> <span class="o">**</span><span class="n">metadata</span><span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metadata.create_empty_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">create_empty_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Creates an empty metadata dictionary for a given pandas DataFrame.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The DataFrame in question.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A dictionary where each key corresponds to a column name in the DataFrame, and each value is an empty dictionary.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metadata.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">create_empty_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an empty metadata dictionary for a given pandas DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The DataFrame in question.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary where each key corresponds to a column name in the DataFrame, and each value is an empty dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="p">{}</span> <span class="k">for</span> <span class="n">cn</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metadata.load_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_metadata</span><span class="p">(</span><span class="n">in_path</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Load metadata from a YAML file located at <code>in_path</code>. If the file does not exist, create an empty metadata
dictionary with column names from the <code>data</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>in_path</code></td>
        <td><code>Path</code></td>
        <td><p>The path to the YAML file containing the metadata.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The DataFrame containing the data for which metadata is being loaded.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A metadata dictionary containing information about the columns in the <code>data</code>.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metadata.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_metadata</span><span class="p">(</span><span class="n">in_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load metadata from a YAML file located at `in_path`. If the file does not exist, create an empty metadata</span>
<span class="sd">    dictionary with column names from the `data`.</span>

<span class="sd">    Args:</span>
<span class="sd">        in_path: The path to the YAML file containing the metadata.</span>
<span class="sd">        data: The DataFrame containing the data for which metadata is being loaded.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A metadata dictionary containing information about the columns in the `data`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">in_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>
        <span class="c1"># Filter out expanded alias/anchor groups</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">filter_dict</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;transformers&quot;</span><span class="p">,</span> <span class="s2">&quot;column_types&quot;</span><span class="p">})</span>
        <span class="n">check_metadata_columns</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">create_empty_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">metadata</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metadata.output_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">output_metadata</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">collapse_yaml</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Writes metadata to a YAML file.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>out_path</code></td>
        <td><code>Path</code></td>
        <td><p>The path at which to write the metadata YAML file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>metadata</code></td>
        <td><code>dict</code></td>
        <td><p>The metadata dictionary to be written.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>collapse_yaml</code></td>
        <td><code>bool</code></td>
        <td><p>A boolean indicating whether to collapse the YAML representation of the metadata, reducing duplication.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metadata.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">output_metadata</span><span class="p">(</span>
    <span class="n">out_path</span><span class="p">:</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">collapse_yaml</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes metadata to a YAML file.</span>

<span class="sd">    Args:</span>
<span class="sd">        out_path: The path at which to write the metadata YAML file.</span>
<span class="sd">        metadata: The metadata dictionary to be written.</span>
<span class="sd">        collapse_yaml: A boolean indicating whether to collapse the YAML representation of the metadata, reducing duplication.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">collapse_yaml</span><span class="p">:</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">collapse</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yaml_file</span><span class="p">:</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">safe_dump</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">yaml_file</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.dataloader.metatransformer" class="doc doc-heading">
        <code>metatransformer</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer" class="doc doc-heading">
        <code>
MetaTransformer        </code>



</h4>

    <div class="doc doc-contents ">

      <p>A metatransformer object that can wrap either a <code>HyperTransformer</code> from RDT or a <code>BaseSingleTableSynthesizer</code> from SDV. The metatransformer
is responsible for transforming input data into a format that can be used by the model module, and transforming the module's output back to
the original format of the input data.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>metadata</code></td>
        <td></td>
        <td><p>A dictionary mapping column names to their metadata.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>sdv_workflow</code></td>
        <td></td>
        <td><p>A flag indicating whether or not to use the SDV workflow.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>allow_null_transformers</code></td>
        <td></td>
        <td><p>A flag indicating whether or not to allow null transformers on some / all columns.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>synthesizer</code></td>
        <td></td>
        <td><p>The <code>BaseSingleTableSynthesizer</code> class to use within the SDV workflow.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>      <p>Once instantiated via <code>mt = MetaTransformer(&lt;parameters&gt;)</code>, the following attributes will be available:</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>sdv_workflow</code></td>
        <td><code>bool</code></td>
        <td><p>A flag indicating whether or not to use the SDV workflow.</p></td>
      </tr>
      <tr>
        <td><code>allow_null_transformers</code></td>
        <td><code>bool</code></td>
        <td><p>A flag indicating whether or not to allow null transformers on some / all columns.</p></td>
      </tr>
      <tr>
        <td><code>Synthesizer</code></td>
        <td><code>BaseSingleTableSynthesizer</code></td>
        <td><p>The <code>BaseSingleTableSynthesizer</code> class to use within the SDV workflow.</p></td>
      </tr>
      <tr>
        <td><code>dtypes</code></td>
        <td><code>dict[str, dict[str, Any]]</code></td>
        <td><p>A dictionary mapping each column to its specified pandas dtype (will infer from pandas defaults if this is missing).</p></td>
      </tr>
      <tr>
        <td><code>sdtypes</code></td>
        <td><code>dict[str, dict[str, Any]]</code></td>
        <td><p>A dictionary mapping each column to the appropriate SDV-specific data type.</p></td>
      </tr>
      <tr>
        <td><code>transformers</code></td>
        <td><code>dict[str, BaseTransformer | None]</code></td>
        <td><p>A dictionary mapping each column to their assigned (if any) transformer.</p></td>
      </tr>
  </tbody>
</table>      <p>After preparing some data with the MetaTransformer, i.e. <code>prepared_data = mt.apply(data)</code>, the following attributes and methods will be available:</p>

<p><strong>Attributes:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>metatransformer</code></td>
        <td><code>HyperTransformer | self.Synthesizer</code></td>
        <td><p>An instanatiated <code>HyperTransformer</code> or <code>self.Synthesizer</code> object, ready to use on data.</p></td>
      </tr>
      <tr>
        <td><code>assembled_metadata</code></td>
        <td><code>dict[str, dict[str, Any]]</code></td>
        <td><p>A dictionary containing the formatted and complete metadata for the MetaTransformer.</p></td>
      </tr>
      <tr>
        <td><code>categoricals</code></td>
        <td><code>dict[str, int]</code></td>
        <td><p>A dictionary mapping categorical columns to the number of levels in the variable.</p></td>
      </tr>
      <tr>
        <td><code>num_continuous</code></td>
        <td><code>int</code></td>
        <td><p>The number of continuous columns.</p></td>
      </tr>
  </tbody>
</table>      <p><strong>Methods:</strong></p>
<ul>
<li><code>get_assembled_metadata()</code>: Return the assembled metadata.</li>
<li><code>order(prepared_data)</code>: Order the prepared data according to the MetaTransformer's <code>categoricals</code> and <code>num_continuous</code> attributes.</li>
<li><code>inverse_apply(synthetic_data)</code>: Apply the inverse of the MetaTransformer to the given data.</li>
</ul>
<p>Note that <code>mt.apply</code> is a helper function that runs <code>mt.apply_dtypes</code>, <code>mt.instaniate</code>, <code>mt.assemble</code>, <code>mt.infer_categoricals</code>,
<code>mt.infer_num_continuous</code>, and finally <code>mt.prepare</code> in sequence on a given raw dataset. Along the way it assigns the attributes listed above.
This workflow is highly encouraged to ensure that the MetaTransformer is properly instantiated for use with the model module.</p>

        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MetaTransformer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A metatransformer object that can wrap either a `HyperTransformer` from RDT or a `BaseSingleTableSynthesizer` from SDV. The metatransformer</span>
<span class="sd">    is responsible for transforming input data into a format that can be used by the model module, and transforming the module&#39;s output back to</span>
<span class="sd">    the original format of the input data.</span>

<span class="sd">    Args:</span>
<span class="sd">        metadata: A dictionary mapping column names to their metadata.</span>
<span class="sd">        sdv_workflow: A flag indicating whether or not to use the SDV workflow.</span>
<span class="sd">        allow_null_transformers: A flag indicating whether or not to allow null transformers on some / all columns.</span>
<span class="sd">        synthesizer: The `BaseSingleTableSynthesizer` class to use within the SDV workflow.</span>

<span class="sd">    Once instantiated via `mt = MetaTransformer(&lt;parameters&gt;)`, the following attributes will be available:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        sdv_workflow: A flag indicating whether or not to use the SDV workflow.</span>
<span class="sd">        allow_null_transformers: A flag indicating whether or not to allow null transformers on some / all columns.</span>
<span class="sd">        Synthesizer: The `BaseSingleTableSynthesizer` class to use within the SDV workflow.</span>
<span class="sd">        dtypes: A dictionary mapping each column to its specified pandas dtype (will infer from pandas defaults if this is missing).</span>
<span class="sd">        sdtypes: A dictionary mapping each column to the appropriate SDV-specific data type.</span>
<span class="sd">        transformers: A dictionary mapping each column to their assigned (if any) transformer.</span>

<span class="sd">    After preparing some data with the MetaTransformer, i.e. `prepared_data = mt.apply(data)`, the following attributes and methods will be available:</span>

<span class="sd">    Attributes:</span>
<span class="sd">        metatransformer (HyperTransformer | self.Synthesizer): An instanatiated `HyperTransformer` or `self.Synthesizer` object, ready to use on data.</span>
<span class="sd">        assembled_metadata (dict[str, dict[str, Any]]): A dictionary containing the formatted and complete metadata for the MetaTransformer.</span>
<span class="sd">        categoricals (dict[str, int]): A dictionary mapping categorical columns to the number of levels in the variable.</span>
<span class="sd">        num_continuous (int): The number of continuous columns.</span>

<span class="sd">    **Methods:**</span>

<span class="sd">    - `get_assembled_metadata()`: Return the assembled metadata.</span>
<span class="sd">    - `order(prepared_data)`: Order the prepared data according to the MetaTransformer&#39;s `categoricals` and `num_continuous` attributes.</span>
<span class="sd">    - `inverse_apply(synthetic_data)`: Apply the inverse of the MetaTransformer to the given data.</span>

<span class="sd">    Note that `mt.apply` is a helper function that runs `mt.apply_dtypes`, `mt.instaniate`, `mt.assemble`, `mt.infer_categoricals`,</span>
<span class="sd">    `mt.infer_num_continuous`, and finally `mt.prepare` in sequence on a given raw dataset. Along the way it assigns the attributes listed above.</span>
<span class="sd">    This workflow is highly encouraged to ensure that the MetaTransformer is properly instantiated for use with the model module.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">sdv_workflow</span><span class="p">,</span> <span class="n">allow_null_transformers</span><span class="p">,</span> <span class="n">synthesizer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># self.metadata: dict[str, dict[str, Any]] = metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">sdv_workflow</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">allow_null_transformers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">:</span> <span class="n">BaseSingleTableSynthesizer</span> <span class="o">=</span> <span class="n">SDV_SYNTHESIZER_CHOICES</span><span class="p">[</span><span class="n">synthesizer</span><span class="p">]</span>
        <span class="c1"># TODO think about whether these belong here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="n">cd</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">cn</span><span class="p">:</span> <span class="n">filter_dict</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;dtype&quot;</span><span class="p">,</span> <span class="s2">&quot;transformer&quot;</span><span class="p">})</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">BaseTransformer</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="n">get_transformer</span><span class="p">(</span><span class="n">cd</span><span class="p">)</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">apply_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies dtypes from the metadata to `data` and infers missing dtypes by reading pandas defaults.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The raw input DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The data with the dtypes applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incomplete metadata, detecting missing `dtype`s for column(s): </span><span class="si">{</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s2"> automatically...&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cn</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cv</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_instantiate_synthesizer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseSingleTableSynthesizer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates a `self.Synthesizer` object from the given metadata and data. Infers missing metadata (sdtypes and transformers).</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A fully instantiated `self.Synthesizer` object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If the metadata is incomplete and `self.allow_null_transformers` is `False`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">SingleTableMetadata</span><span class="o">.</span><span class="n">load_from_dict</span><span class="p">({</span><span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incomplete metadata, detecting missing `sdtype`s for column(s): </span><span class="si">{</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s2"> automatically...&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">SingleTableMetadata</span><span class="p">()</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">detect_from_dataframe</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">values</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">values</span><span class="p">:</span>
                    <span class="n">metadata</span><span class="o">.</span><span class="n">update_column</span><span class="p">(</span><span class="n">column_name</span><span class="o">=</span><span class="n">column_name</span><span class="p">,</span> <span class="o">**</span><span class="n">values</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incomplete metadata, detecting missing `transformers`s for column(s): </span><span class="si">{</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s2"> automatically...&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">synthesizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Synthesizer</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
        <span class="n">synthesizer</span><span class="o">.</span><span class="n">auto_assign_transformers</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">synthesizer</span><span class="o">.</span><span class="n">update_transformers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span> <span class="k">else</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">synthesizer</span>

    <span class="k">def</span> <span class="nf">_instantiate_hypertransformer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HyperTransformer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates a `HyperTransformer` object from the metadata and given data. Infers missing metadata (sdtypes and transformers).</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A fully instantiated `HyperTransformer` object.</span>

<span class="sd">        Raises:</span>
<span class="sd">            UserWarning: If the metadata is incomplete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="n">HyperTransformer</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span><span class="p">):</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">set_config</span><span class="p">(</span>
                <span class="n">config</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;sdtypes&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
                    <span class="s2">&quot;transformers&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incomplete metadata, detecting missing</span><span class="si">{</span><span class="p">(</span><span class="s1">&#39; `sdtype`s for column(s): &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">([</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}{</span><span class="p">(</span><span class="s1">&#39; `transformer`s for column(s): &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">str</span><span class="p">([</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">values</span><span class="p">())</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2"> automatically...&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">detect_initial_config</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">update_sdtypes</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">})</span>
            <span class="n">ht</span><span class="o">.</span><span class="n">update_transformers</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_null_transformers</span> <span class="k">else</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ht</span>

    <span class="k">def</span> <span class="nf">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseSingleTableSynthesizer</span> <span class="o">|</span> <span class="n">HyperTransformer</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calls the appropriate instantiation method based on the value of `self.sdv_workflow`.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The input DataFrame.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A fully instantiated `self.Synthesizer` or `HyperTransformer` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_synthesizer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_hypertransformer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cn</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the dtype for the given column name `cn`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">cn</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Rearranges the dtype, sdtype and transformer metadata into a consistent format regardless of the value of `self,sdv_workflow`</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping column names to column metadata.</span>
<span class="sd">                The metadata for each column has the following keys:</span>
<span class="sd">                - dtype: The pandas data type for the column</span>
<span class="sd">                - sdtype: The SDV-specific data type for the column.</span>
<span class="sd">                - transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:</span>
<span class="sd">                    - name: The name of the transformer.</span>
<span class="sd">                    - Any other properties of the transformer that we want to record in output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
            <span class="n">sdmetadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">metadata</span>
            <span class="n">transformers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">get_transformers</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">cn</span><span class="p">:</span> <span class="p">{</span>
                    <span class="o">**</span><span class="n">cd</span><span class="p">,</span>
                    <span class="s2">&quot;transformer&quot;</span><span class="p">:</span> <span class="n">make_transformer_dict</span><span class="p">(</span><span class="n">transformers</span><span class="p">[</span><span class="n">cn</span><span class="p">])</span> <span class="k">if</span> <span class="n">transformers</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">cn</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">sdmetadata</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="n">cn</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;sdtype&quot;</span><span class="p">:</span> <span class="n">cd</span><span class="p">,</span>
                    <span class="s2">&quot;transformer&quot;</span><span class="p">:</span> <span class="n">make_transformer_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">][</span><span class="n">cn</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">][</span><span class="n">cn</span><span class="p">]</span>
                    <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">cn</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sdtypes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="p">}</span>

    <span class="k">def</span> <span class="nf">infer_categoricals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the (assembled) metadata to identify the categorical columns from the data and count the number of levels each categorical variable has.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data to infer the categorical columns from using `self.assembled_metadata`</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping column names to the number of unique values in the column (if the column is categorical).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">infer_num_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uses the (assembled) metadata to infers the number of continuous columns in the data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The number of continuous columns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cd</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;categorical&quot;</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the data by processing it via the metatransformer.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data to fit and apply the transformer to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the various steps of the MetaTransformer to a passed DataFrame.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The DataFrame to transform.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The transformed data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_dtypes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_categoricals</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_num_continuous</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_assembled_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the assembled metadata for the transformer.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dictionary mapping column names to column metadata.</span>
<span class="sd">                The metadata for each column has the following keys:</span>
<span class="sd">                - dtype: The pandas data type for the column</span>
<span class="sd">                - sdtype: The SDV-specific data type for the column.</span>
<span class="sd">                - transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:</span>
<span class="sd">                    - name: The name of the transformer.</span>
<span class="sd">                    - Any other properties of the transformer that we want to record in output.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the metadata has not yet been assembled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Metadata has not yet been assembled. Call `MetaTransformer.apply` (or `MetaTransformer.assemble`) first.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span>

    <span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Orders the data based on the inferred categorical and continuous columns.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data to order.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing the ordered data, a list of the number of unique values for each categorical column, and the number of continuous columns.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the metadata has not yet been finalised and assembled or `categoricals` and/or `num_continuous` have yet to be inferred.</span>
<span class="sd">            ValueError: If a column in `self.assembled_metadata` is not found in the passed data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Some metadata is missing. Call `mt.apply(data)` first (or `mt.[assemble(),infer_categoricals(data),infer_num_continuous()]` in sequence).&quot;</span>
            <span class="p">)</span>
        <span class="n">categorical_ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">continuous_ordering</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OneHotEncoder&quot;</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">cn</span> <span class="o">+</span> <span class="s2">&quot;.value0&quot;</span><span class="p">)</span>
                <span class="n">categorical_ordering</span> <span class="o">+=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span><span class="p">[</span><span class="n">cn</span><span class="p">])]</span>
            <span class="k">elif</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2"> column was not found in the passed data.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">continuous_ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">cn</span><span class="p">))</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="n">categorical_ordering</span> <span class="o">+</span> <span class="n">continuous_ordering</span>
        <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ordering</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span>

    <span class="k">def</span> <span class="nf">inverse_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reverses the transformation applied by the MetaTransformer.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The transformed data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The original data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">reverse_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">reverse_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Applies the various steps of the MetaTransformer to a passed DataFrame.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The DataFrame to transform.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>DataFrame</code></td>
      <td><p>The transformed data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the various steps of the MetaTransformer to a passed DataFrame.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The DataFrame to transform.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The transformed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">typed_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_dtypes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instantiate</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assemble</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_categoricals</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_num_continuous</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">typed_data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.apply_dtypes" class="doc doc-heading">
<code class="highlight language-python"><span class="n">apply_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Applies dtypes from the metadata to <code>data</code> and infers missing dtypes by reading pandas defaults.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The raw input DataFrame.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>DataFrame</code></td>
      <td><p>The data with the dtypes applied.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">apply_dtypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies dtypes from the metadata to `data` and infers missing dtypes by reading pandas defaults.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The raw input DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The data with the dtypes applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Incomplete metadata, detecting missing `dtype`s for column(s): </span><span class="si">{</span><span class="p">[</span><span class="n">k</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">v</span><span class="p">]</span><span class="si">}</span><span class="s2"> automatically...&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">cn</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cv</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dtypes</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.assemble" class="doc doc-heading">
<code class="highlight language-python"><span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Rearranges the dtype, sdtype and transformer metadata into a consistent format regardless of the value of <code>self,sdv_workflow</code></p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>A dictionary mapping column names to column metadata.
    The metadata for each column has the following keys</code></td>
      <td><ul>
<li>dtype: The pandas data type for the column<ul>
<li>sdtype: The SDV-specific data type for the column.</li>
<li>transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:<ul>
<li>name: The name of the transformer.</li>
<li>Any other properties of the transformer that we want to record in output.</li>
</ul>
</li>
</ul>
</li>
</ul></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rearranges the dtype, sdtype and transformer metadata into a consistent format regardless of the value of `self,sdv_workflow`</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping column names to column metadata.</span>
<span class="sd">            The metadata for each column has the following keys:</span>
<span class="sd">            - dtype: The pandas data type for the column</span>
<span class="sd">            - sdtype: The SDV-specific data type for the column.</span>
<span class="sd">            - transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:</span>
<span class="sd">                - name: The name of the transformer.</span>
<span class="sd">                - Any other properties of the transformer that we want to record in output.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
        <span class="n">sdmetadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">metadata</span>
        <span class="n">transformers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">get_transformers</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">cn</span><span class="p">:</span> <span class="p">{</span>
                <span class="o">**</span><span class="n">cd</span><span class="p">,</span>
                <span class="s2">&quot;transformer&quot;</span><span class="p">:</span> <span class="n">make_transformer_dict</span><span class="p">(</span><span class="n">transformers</span><span class="p">[</span><span class="n">cn</span><span class="p">])</span> <span class="k">if</span> <span class="n">transformers</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">cn</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">sdmetadata</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">cn</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;sdtype&quot;</span><span class="p">:</span> <span class="n">cd</span><span class="p">,</span>
                <span class="s2">&quot;transformer&quot;</span><span class="p">:</span> <span class="n">make_transformer_dict</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">][</span><span class="n">cn</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;transformers&quot;</span><span class="p">][</span><span class="n">cn</span><span class="p">]</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dtype</span><span class="p">(</span><span class="n">cn</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;sdtypes&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.get_assembled_metadata" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_assembled_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Returns the assembled metadata for the transformer.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>A dictionary mapping column names to column metadata.
    The metadata for each column has the following keys</code></td>
      <td><ul>
<li>dtype: The pandas data type for the column<ul>
<li>sdtype: The SDV-specific data type for the column.</li>
<li>transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:<ul>
<li>name: The name of the transformer.</li>
<li>Any other properties of the transformer that we want to record in output.</li>
</ul>
</li>
</ul>
</li>
</ul></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If the metadata has not yet been assembled.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_assembled_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the assembled metadata for the transformer.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping column names to column metadata.</span>
<span class="sd">            The metadata for each column has the following keys:</span>
<span class="sd">            - dtype: The pandas data type for the column</span>
<span class="sd">            - sdtype: The SDV-specific data type for the column.</span>
<span class="sd">            - transformer: A dictionary containing information about the transformer used for the column (if any). The dictionary has the following keys:</span>
<span class="sd">                - name: The name of the transformer.</span>
<span class="sd">                - Any other properties of the transformer that we want to record in output.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the metadata has not yet been assembled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Metadata has not yet been assembled. Call `MetaTransformer.apply` (or `MetaTransformer.assemble`) first.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.infer_categoricals" class="doc doc-heading">
<code class="highlight language-python"><span class="n">infer_categoricals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Uses the (assembled) metadata to identify the categorical columns from the data and count the number of levels each categorical variable has.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The data to infer the categorical columns from using <code>self.assembled_metadata</code></p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A dictionary mapping column names to the number of unique values in the column (if the column is categorical).</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">infer_categoricals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the (assembled) metadata to identify the categorical columns from the data and count the number of levels each categorical variable has.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data to infer the categorical columns from using `self.assembled_metadata`</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary mapping column names to the number of unique values in the column (if the column is categorical).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">cn</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">cn</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.infer_num_continuous" class="doc doc-heading">
<code class="highlight language-python"><span class="n">infer_num_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Uses the (assembled) metadata to infers the number of continuous columns in the data.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of continuous columns</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">infer_num_continuous</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the (assembled) metadata to infers the number of continuous columns in the data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The number of continuous columns</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cd</span><span class="p">[</span><span class="s2">&quot;sdtype&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;categorical&quot;</span> <span class="k">for</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.instantiate" class="doc doc-heading">
<code class="highlight language-python"><span class="n">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Calls the appropriate instantiation method based on the value of <code>self.sdv_workflow</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The input DataFrame.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>sdv.single_table.base.BaseSingleTableSynthesizer | rdt.hyper_transformer.HyperTransformer</code></td>
      <td><p>A fully instantiated <code>self.Synthesizer</code> or <code>HyperTransformer</code> object.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">instantiate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseSingleTableSynthesizer</span> <span class="o">|</span> <span class="n">HyperTransformer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calls the appropriate instantiation method based on the value of `self.sdv_workflow`.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The input DataFrame.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A fully instantiated `self.Synthesizer` or `HyperTransformer` object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_synthesizer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_instantiate_hypertransformer</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.inverse_apply" class="doc doc-heading">
<code class="highlight language-python"><span class="n">inverse_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Reverses the transformation applied by the MetaTransformer.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The transformed data.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>DataFrame</code></td>
      <td><p>The original data.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">inverse_apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reverses the transformation applied by the MetaTransformer.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The transformed data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The original data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">reverse_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">reverse_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.order" class="doc doc-heading">
<code class="highlight language-python"><span class="n">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Orders the data based on the inferred categorical and continuous columns.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The data to order.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>A tuple containing the ordered data, a list of the number of unique values for each categorical column, and the number of continuous columns.</p></td>
    </tr>
  </tbody>
</table>
<p><strong>Exceptions:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If the metadata has not yet been finalised and assembled or <code>categoricals</code> and/or <code>num_continuous</code> have yet to be inferred.</p></td>
      </tr>
      <tr>
        <td><code>ValueError</code></td>
        <td><p>If a column in <code>self.assembled_metadata</code> is not found in the passed data.</p></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orders the data based on the inferred categorical and continuous columns.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data to order.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the ordered data, a list of the number of unique values for each categorical column, and the number of continuous columns.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the metadata has not yet been finalised and assembled or `categoricals` and/or `num_continuous` have yet to be inferred.</span>
<span class="sd">        ValueError: If a column in `self.assembled_metadata` is not found in the passed data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Some metadata is missing. Call `mt.apply(data)` first (or `mt.[assemble(),infer_categoricals(data),infer_num_continuous()]` in sequence).&quot;</span>
        <span class="p">)</span>
    <span class="n">categorical_ordering</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">continuous_ordering</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cn</span><span class="p">,</span> <span class="n">cd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembled_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">cd</span><span class="p">[</span><span class="s2">&quot;transformer&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OneHotEncoder&quot;</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">cn</span> <span class="o">+</span> <span class="s2">&quot;.value0&quot;</span><span class="p">)</span>
            <span class="n">categorical_ordering</span> <span class="o">+=</span> <span class="p">[</span><span class="o">*</span><span class="nb">range</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">idx</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span><span class="p">[</span><span class="n">cn</span><span class="p">])]</span>
        <span class="k">elif</span> <span class="n">cn</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="n">cn</span><span class="si">}</span><span class="s2"> column was not found in the passed data.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">continuous_ordering</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">cn</span><span class="p">))</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="n">categorical_ordering</span> <span class="o">+</span> <span class="n">continuous_ordering</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ordering</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">categoricals</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.dataloader.metatransformer.MetaTransformer.prepare" class="doc doc-heading">
<code class="highlight language-python"><span class="n">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Prepares the data by processing it via the metatransformer.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>data</code></td>
        <td><code>DataFrame</code></td>
        <td><p>The data to fit and apply the transformer to.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepares the data by processing it via the metatransformer.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data to fit and apply the transformer to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metatransformer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>




  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metatransformer.get_transformer" class="doc doc-heading">
<code class="highlight language-python"><span class="n">get_transformer</span><span class="p">(</span><span class="n">d</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Return a callable transformer object constructed from data in the given dictionary.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>d</code></td>
        <td><code>dict</code></td>
        <td><p>A dictionary containing the transformer data.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>rdt.transformers.base.BaseTransformer | None</code></td>
      <td><p>An instantiated <code>BaseTransformer</code> if the dictionary contains valid transformer data, else None.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_transformer</span><span class="p">(</span><span class="n">d</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BaseTransformer</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return a callable transformer object constructed from data in the given dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        d: A dictionary containing the transformer data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instantiated `BaseTransformer` if the dictionary contains valid transformer data, else None.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">transformer_data</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;transformer&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformer_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">transformer_data</span><span class="p">:</span>
        <span class="c1"># Need to copy in case dicts are shared across columns, this can happen when reading a yaml with anchors</span>
        <span class="n">transformer_data</span> <span class="o">=</span> <span class="n">transformer_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">transformer_name</span> <span class="o">=</span> <span class="n">transformer_data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">transformer_name</span><span class="p">)(</span><span class="o">**</span><span class="n">transformer_data</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">transformer_data</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="n">transformer_data</span><span class="p">)()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.metatransformer.make_transformer_dict" class="doc doc-heading">
<code class="highlight language-python"><span class="n">make_transformer_dict</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Deconstruct a <code>transformer</code> into a dictionary of config.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>transformer</code></td>
        <td><code>BaseTransformer</code></td>
        <td><p>A BaseTransformer object from RDT (SDV).</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>A dictionary containing the transformer's name and arguments.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/metatransformer.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">make_transformer_dict</span><span class="p">(</span><span class="n">transformer</span><span class="p">:</span> <span class="n">BaseTransformer</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deconstruct a `transformer` into a dictionary of config.</span>

<span class="sd">    Args:</span>
<span class="sd">        transformer: A BaseTransformer object from RDT (SDV).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary containing the transformer&#39;s name and arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">transformer</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="o">**</span><span class="n">filter_dict</span><span class="p">(</span>
            <span class="n">transformer</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;output_properties&quot;</span><span class="p">,</span> <span class="s2">&quot;random_states&quot;</span><span class="p">,</span> <span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="s2">&quot;reverse_transform&quot;</span><span class="p">,</span> <span class="s2">&quot;_dtype&quot;</span><span class="p">},</span>
        <span class="p">),</span>
    <span class="p">}</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.dataloader.run" class="doc doc-heading">
        <code>run</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.dataloader.run.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Runs the main workflow of the dataloader module, transforming the input data and writing the output and transformer used to file.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>args</code></td>
        <td><code>Namespace</code></td>
        <td><p>An argparse Namespace containing the command line arguments.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/dataloader/run.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs the main workflow of the dataloader module, transforming the input data and writing the output and transformer used to file.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: An argparse Namespace containing the command line arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running dataloader module...&quot;</span><span class="p">)</span>

    <span class="n">set_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">dir_experiment</span> <span class="o">=</span> <span class="n">experiment_io</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">)</span>

    <span class="n">dir_input</span><span class="p">,</span> <span class="n">fn_input_data</span><span class="p">,</span> <span class="n">fn_metadata</span> <span class="o">=</span> <span class="n">check_input_paths</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">input</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>

    <span class="c1"># Load the dataset and accompanying metadata</span>
    <span class="nb">input</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">/</span> <span class="n">fn_input_data</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">index_col</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">load_metadata</span><span class="p">(</span><span class="n">dir_input</span> <span class="o">/</span> <span class="n">fn_metadata</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>

    <span class="n">mt</span> <span class="o">=</span> <span class="n">MetaTransformer</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">sdv_workflow</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">allow_null_transformers</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">synthesizer</span><span class="p">)</span>
    <span class="n">transformed_input</span> <span class="o">=</span> <span class="n">mt</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>

    <span class="c1"># Output the metadata corresponding to `transformed_input`, for reproducibility</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">discard_metadata</span><span class="p">:</span>
        <span class="n">output_metadata</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_metadata</span><span class="p">,</span> <span class="n">mt</span><span class="o">.</span><span class="n">get_assembled_metadata</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">collapse_yaml</span><span class="p">)</span>

    <span class="c1"># Write the transformed input to the appropriate file</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">modules_to_run</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">modules_to_run</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;dataloader&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">write_all</span><span class="p">:</span>
        <span class="n">fn_output_data</span><span class="p">,</span> <span class="n">fn_transformer</span> <span class="o">=</span> <span class="n">check_output_paths</span><span class="p">(</span>
            <span class="n">fn_input_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">output</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">metatransformer</span><span class="p">,</span> <span class="n">dir_experiment</span>
        <span class="p">)</span>
        <span class="n">write_data_outputs</span><span class="p">(</span><span class="n">transformed_input</span><span class="p">,</span> <span class="n">mt</span><span class="p">,</span> <span class="n">fn_output_data</span><span class="p">,</span> <span class="n">fn_transformer</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span>

    <span class="c1"># TODO Probably some way to ensure modules_to_run exists in args</span>
    <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">modules_to_run</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">dataloader_output</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fn_data&quot;</span><span class="p">:</span> <span class="n">fn_input_data</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">transformed_input</span><span class="p">,</span>
            <span class="s2">&quot;categorical_metadata&quot;</span><span class="p">:</span> <span class="n">mt</span><span class="o">.</span><span class="n">get_categoricals</span><span class="p">(),</span>
            <span class="s2">&quot;metatransformer&quot;</span><span class="p">:</span> <span class="n">mt</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">args</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>




  <div class="doc doc-object doc-module">



<h2 id="nhssynth.modules.model" class="doc doc-heading">
        <code>model</code>


  <span class="doc doc-properties">
      <small class="doc doc-property doc-property-special"><code>special</code></small>
  </span>

</h2>

    <div class="doc doc-contents ">




  <div class="doc doc-children">










  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.model.DPVAE" class="doc doc-heading">
        <code>DPVAE</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">







  <div class="doc doc-object doc-class">



<h4 id="nhssynth.modules.model.DPVAE.Decoder" class="doc doc-heading">
        <code>
Decoder            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



</h4>

    <div class="doc doc-contents ">

      <p>Decoder, takes in z and outputs reconstruction</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Decoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decoder, takes in z and outputs reconstruction&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">latent_dim</span><span class="p">,</span>
        <span class="n">num_continuous</span><span class="p">,</span>
        <span class="n">num_categories</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;gpu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">output_dim</span> <span class="o">=</span> <span class="n">num_continuous</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">num_categories</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="o">=</span> <span class="n">num_continuous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span> <span class="o">=</span> <span class="n">num_categories</span>

        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoder: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> specified, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> used&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Decoder: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> specified, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> used&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">latent_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">activation</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">activation</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.model.DPVAE.Decoder.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Defines the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="nhssynth.modules.model.DPVAE.Encoder" class="doc doc-heading">
        <code>
Encoder            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



</h4>

    <div class="doc doc-contents ">

      <p>Encoder, takes in x
and outputs mu_z, sigma_z
(diagonal Gaussian variational posterior assumed)</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Encoder</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Encoder, takes in x</span>
<span class="sd">    and outputs mu_z, sigma_z</span>
<span class="sd">    (diagonal Gaussian variational posterior assumed)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_dim</span><span class="p">,</span>
        <span class="n">latent_dim</span><span class="p">,</span>
        <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">activation</span><span class="o">=</span><span class="n">nn</span><span class="o">.</span><span class="n">Tanh</span><span class="p">,</span>
        <span class="n">device</span><span class="o">=</span><span class="s2">&quot;gpu&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cuda:0&quot;</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> specified, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> used&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Encoder: </span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2"> specified, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="si">}</span><span class="s2"> used&quot;</span><span class="p">)</span>
        <span class="n">output_dim</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">latent_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="o">=</span> <span class="n">latent_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">input_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">activation</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">activation</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">mu_z</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">]</span>
        <span class="n">logsigma_z</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="p">:]</span>
        <span class="k">return</span> <span class="n">mu_z</span><span class="p">,</span> <span class="n">logsigma_z</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.model.DPVAE.Encoder.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Defines the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="n">outs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">net</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">mu_z</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">]</span>
    <span class="n">logsigma_z</span> <span class="o">=</span> <span class="n">outs</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latent_dim</span> <span class="p">:]</span>
    <span class="k">return</span> <span class="n">mu_z</span><span class="p">,</span> <span class="n">logsigma_z</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="nhssynth.modules.model.DPVAE.Noiser" class="doc doc-heading">
        <code>
Noiser            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



</h4>

    <div class="doc doc-contents ">


        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">Noiser</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_continuous</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">num_continuous</span><span class="p">,</span> <span class="n">num_continuous</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">init</span><span class="o">.</span><span class="n">zeros_</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span><span class="o">.</span><span class="n">weight</span><span class="o">.</span><span class="n">requires_grad</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">










  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.model.DPVAE.Noiser.forward" class="doc doc-heading">
<code class="highlight language-python"><span class="n">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Defines the computation performed at every call.</p>
<p>Should be overridden by all subclasses.</p>
<p>.. note::
    Although the recipe for forward pass needs to be defined within
    this function, one should call the :class:<code>Module</code> instance afterwards
    instead of this since the former takes care of running the
    registered hooks while the latter silently ignores them.</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_logsigma_fn</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>



  <div class="doc doc-object doc-class">



<h4 id="nhssynth.modules.model.DPVAE.VAE" class="doc doc-heading">
        <code>
VAE            (<span title="torch.nn.modules.module.Module">Module</span>)
        </code>



</h4>

    <div class="doc doc-contents ">

      <p>Combines encoder and decoder into full VAE model</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">VAE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Combines encoder and decoder into full VAE model&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">encoder</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">decoder</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">encoder</span><span class="o">.</span><span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">num_categories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">num_continuous</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noiser</span> <span class="o">=</span> <span class="n">Noiser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">decoder</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="n">lr</span>

    <span class="k">def</span> <span class="nf">reconstruct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">mu_z</span><span class="p">,</span> <span class="n">logsigma_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">mu_z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_recon</span>

    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
        <span class="n">z_samples</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">)),</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">x_gen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z_samples</span><span class="p">)</span>
        <span class="n">x_gen_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_gen</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">)):</span>
            <span class="n">x_gen_</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">])]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">one_hot_categorical</span><span class="o">.</span><span class="n">OneHotCategorical</span><span class="p">(</span>
                <span class="n">logits</span><span class="o">=</span><span class="n">x_gen</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">])]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="n">x_gen_</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x_gen</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noiser</span><span class="p">(</span><span class="n">x_gen</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:])</span>
        <span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">x_gen</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:])</span>
        <span class="k">return</span> <span class="n">x_gen_</span>

    <span class="k">def</span> <span class="nf">loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">mu_z</span><span class="p">,</span> <span class="n">logsigma_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu_z</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_z</span><span class="p">))</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="n">mu_z</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logsigma_z</span><span class="p">))</span>

        <span class="n">divergence_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">kl_divergence</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn_like</span><span class="p">(</span><span class="n">mu_z</span><span class="p">)</span>
        <span class="n">z_samples</span> <span class="o">=</span> <span class="n">mu_z</span> <span class="o">+</span> <span class="n">s</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logsigma_z</span><span class="p">)</span>

        <span class="n">x_recon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">z_samples</span><span class="p">)</span>

        <span class="n">categoric_loglik</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">)):</span>

                <span class="n">categoric_loglik</span> <span class="o">+=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span>
                    <span class="n">x_recon</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">])],</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="n">i</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">])],</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">num_categories</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

        <span class="n">gauss_loglik</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="o">.</span><span class="n">num_continuous</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gauss_loglik</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Normal</span><span class="p">(</span>
                    <span class="n">loc</span><span class="o">=</span><span class="n">x_recon</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:],</span>
                    <span class="n">scale</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">noiser</span><span class="p">(</span><span class="n">x_recon</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:])),</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">num_continuous</span> <span class="p">:])</span>
                <span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="n">reconstruct_loss</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">categoric_loglik</span> <span class="o">+</span> <span class="n">gauss_loglik</span><span class="p">)</span>

        <span class="n">elbo</span> <span class="o">=</span> <span class="n">divergence_loss</span> <span class="o">+</span> <span class="n">reconstruct_loss</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">elbo</span><span class="p">,</span> <span class="n">reconstruct_loss</span><span class="p">,</span> <span class="n">divergence_loss</span><span class="p">,</span> <span class="n">categoric_loglik</span><span class="p">,</span> <span class="n">gauss_loglik</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_dataloader</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">logging_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># mean_norm = 0</span>
        <span class="c1"># counter = 0</span>
        <span class="n">log_elbo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_reconstruct</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_divergence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_cat_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_num_loss</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># EARLY STOPPING #</span>
        <span class="n">min_elbo</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># For early stopping workflow</span>
        <span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>  <span class="c1"># How many epochs patience we give for early stopping</span>
        <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for stops</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>  <span class="c1"># Difference in elbo value</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>

            <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">divergence_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">reconstruction_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">categorical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">numerical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">Y_subset</span><span class="p">,)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">x_dataloader</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="p">(</span>
                    <span class="n">elbo</span><span class="p">,</span>
                    <span class="n">reconstruct_loss</span><span class="p">,</span>
                    <span class="n">divergence_loss</span><span class="p">,</span>
                    <span class="n">categorical_reconstruc</span><span class="p">,</span>
                    <span class="n">numerical_reconstruct</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">Y_subset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                <span class="n">elbo</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">elbo</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">divergence_epoch_loss</span> <span class="o">+=</span> <span class="n">divergence_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">reconstruction_epoch_loss</span> <span class="o">+=</span> <span class="n">reconstruct_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">categorical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">categorical_reconstruc</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">numerical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">numerical_reconstruct</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                <span class="c1"># counter += 1</span>
                <span class="c1"># l2_norm = 0</span>
                <span class="c1"># for p in self.parameters():</span>
                <span class="c1">#     if p.requires_grad:</span>
                <span class="c1">#         p_norm = p.grad.detach().data.norm(2)</span>
                <span class="c1">#         l2_norm += p_norm.item() ** 2</span>
                <span class="c1"># l2_norm = l2_norm ** 0.5  # / Y_subset.shape[0]</span>
                <span class="c1"># mean_norm = (mean_norm * (counter - 1) + l2_norm) / counter</span>

            <span class="n">log_elbo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
            <span class="n">log_reconstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction_epoch_loss</span><span class="p">)</span>
            <span class="n">log_divergence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">divergence_epoch_loss</span><span class="p">)</span>
            <span class="n">log_cat_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">categorical_epoch_reconstruct</span><span class="p">)</span>
            <span class="n">log_num_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numerical_epoch_reconstruct</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>

            <span class="k">if</span> <span class="n">train_loss</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min_elbo</span> <span class="o">-</span> <span class="n">delta</span><span class="p">):</span>

                <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>
                <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set counter to zero</span>
                <span class="k">if</span> <span class="n">filepath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>  <span class="c1"># Save best model if we want to</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># elbo has not improved</span>

                <span class="n">stop_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">logging_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">. Elbo: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Reconstruction Loss: </span><span class="si">{</span><span class="n">reconstruction_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. KL Divergence: </span><span class="si">{</span><span class="n">divergence_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Categorical Loss: </span><span class="si">{</span><span class="n">categorical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Numerical Loss: </span><span class="si">{</span><span class="n">numerical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># print(f&quot;\tMean norm: {mean_norm}&quot;)</span>
            <span class="c1"># self.mean_norm = mean_norm</span>

            <span class="k">if</span> <span class="n">stop_counter</span> <span class="o">==</span> <span class="n">patience</span><span class="p">:</span>

                <span class="n">num_epochs</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">break</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">log_elbo</span><span class="p">,</span>
            <span class="n">log_reconstruct</span><span class="p">,</span>
            <span class="n">log_divergence</span><span class="p">,</span>
            <span class="n">log_cat_loss</span><span class="p">,</span>
            <span class="n">log_num_loss</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">diff_priv_train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x_dataloader</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">C</span><span class="o">=</span><span class="mf">1e16</span><span class="p">,</span>
        <span class="n">noise_scale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">target_epsilon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">target_delta</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span>
        <span class="n">logging_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sample_rate</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
        <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">noise_scale</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">privacy_engine</span> <span class="o">=</span> <span class="n">PrivacyEngine</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">alphas</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">)),</span>
                <span class="n">noise_multiplier</span><span class="o">=</span><span class="n">noise_scale</span><span class="p">,</span>
                <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">privacy_engine</span> <span class="o">=</span> <span class="n">PrivacyEngine</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
                <span class="n">alphas</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span> <span class="o">/</span> <span class="mf">10.0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">)),</span>
                <span class="n">target_epsilonilon</span><span class="o">=</span><span class="n">target_epsilon</span><span class="p">,</span>
                <span class="n">target_delta</span><span class="o">=</span><span class="n">target_delta</span><span class="p">,</span>
                <span class="n">epochs</span><span class="o">=</span><span class="n">num_epochs</span><span class="p">,</span>
                <span class="n">max_grad_norm</span><span class="o">=</span><span class="n">C</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">privacy_engine</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">)</span>

        <span class="n">log_elbo</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_reconstruct</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_divergence</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_cat_loss</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">log_num_loss</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># EARLY STOPPING #</span>
        <span class="n">min_elbo</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># For early stopping workflow</span>
        <span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>  <span class="c1"># How many epochs patience we give for early stopping</span>
        <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for stops</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>  <span class="c1"># Difference in elbo value</span>

        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>
            <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">divergence_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">reconstruction_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">categorical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">numerical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="c1"># print(self.get_privacy_spent(target_delta))</span>

            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">Y_subset</span><span class="p">,)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">x_dataloader</span><span class="p">)):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
                <span class="p">(</span>
                    <span class="n">elbo</span><span class="p">,</span>
                    <span class="n">reconstruct_loss</span><span class="p">,</span>
                    <span class="n">divergence_loss</span><span class="p">,</span>
                    <span class="n">categorical_reconstruct</span><span class="p">,</span>
                    <span class="n">numerical_reconstruct</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">Y_subset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
                <span class="n">elbo</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

                <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">elbo</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">divergence_epoch_loss</span> <span class="o">+=</span> <span class="n">divergence_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">reconstruction_epoch_loss</span> <span class="o">+=</span> <span class="n">reconstruct_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">categorical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">categorical_reconstruct</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">numerical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">numerical_reconstruct</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

                <span class="c1"># print(self.get_privacy_spent(target_delta))</span>
                <span class="c1"># print(loss.item())</span>

            <span class="n">log_elbo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
            <span class="n">log_reconstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction_epoch_loss</span><span class="p">)</span>
            <span class="n">log_divergence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">divergence_epoch_loss</span><span class="p">)</span>
            <span class="n">log_cat_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">categorical_epoch_reconstruct</span><span class="p">)</span>
            <span class="n">log_num_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numerical_epoch_reconstruct</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>

            <span class="k">if</span> <span class="n">train_loss</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min_elbo</span> <span class="o">-</span> <span class="n">delta</span><span class="p">):</span>

                <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>
                <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set counter to zero</span>
                <span class="k">if</span> <span class="n">filepath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>  <span class="c1"># Save best model if we want to</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># elbo has not improved</span>

                <span class="n">stop_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">logging_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">. Elbo: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Reconstruction Loss: </span><span class="si">{</span><span class="n">reconstruction_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. KL Divergence: </span><span class="si">{</span><span class="n">divergence_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Categorical Loss: </span><span class="si">{</span><span class="n">categorical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Numerical Loss: </span><span class="si">{</span><span class="n">numerical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="c1"># print(f&quot;\tMean norm: {mean_norm}&quot;)</span>

            <span class="k">if</span> <span class="n">stop_counter</span> <span class="o">==</span> <span class="n">patience</span><span class="p">:</span>

                <span class="n">num_epochs</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">log_elbo</span><span class="p">,</span>
            <span class="n">log_reconstruct</span><span class="p">,</span>
            <span class="n">log_divergence</span><span class="p">,</span>
            <span class="n">log_cat_loss</span><span class="p">,</span>
            <span class="n">log_num_loss</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_privacy_spent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delta</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;privacy_engine&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">privacy_engine</span><span class="o">.</span><span class="n">get_privacy_spent</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;This VAE object does not a privacy_engine attribute.</span>
<span class="sd">                Run diff_priv_train to create one.&quot;&quot;&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
</code></pre></div>
        </details>



  <div class="doc doc-children">

















  <div class="doc doc-object doc-method">



<h5 id="nhssynth.modules.model.DPVAE.VAE.train" class="doc doc-heading">
<code class="highlight language-python"><span class="n">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_dataloader</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">,</span> <span class="n">logging_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h5>

    <div class="doc doc-contents ">

      <p>Sets the module in training mode.</p>
<p>This has any effect only on certain modules. See documentations of
particular modules for details of their behaviors in training/evaluation
mode, if they are affected, e.g. :class:<code>Dropout</code>, :class:<code>BatchNorm</code>,
etc.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>mode</code></td>
        <td><code>bool</code></td>
        <td><p>whether to set training mode (<code>True</code>) or evaluation
         mode (<code>False</code>). Default: <code>True</code>.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>Module</code></td>
      <td><p>self</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/model/DPVAE.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">x_dataloader</span><span class="p">,</span>
    <span class="n">num_epochs</span><span class="p">,</span>
    <span class="n">logging_freq</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">patience</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">delta</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># mean_norm = 0</span>
    <span class="c1"># counter = 0</span>
    <span class="n">log_elbo</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_reconstruct</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_divergence</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_cat_loss</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">log_num_loss</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># EARLY STOPPING #</span>
    <span class="n">min_elbo</span> <span class="o">=</span> <span class="mf">0.0</span>  <span class="c1"># For early stopping workflow</span>
    <span class="n">patience</span> <span class="o">=</span> <span class="n">patience</span>  <span class="c1"># How many epochs patience we give for early stopping</span>
    <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Counter for stops</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>  <span class="c1"># Difference in elbo value</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_epochs</span><span class="p">):</span>

        <span class="n">train_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">divergence_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">reconstruction_epoch_loss</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">categorical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">numerical_epoch_reconstruct</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">Y_subset</span><span class="p">,)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">x_dataloader</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="p">(</span>
                <span class="n">elbo</span><span class="p">,</span>
                <span class="n">reconstruct_loss</span><span class="p">,</span>
                <span class="n">divergence_loss</span><span class="p">,</span>
                <span class="n">categorical_reconstruc</span><span class="p">,</span>
                <span class="n">numerical_reconstruct</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loss</span><span class="p">(</span><span class="n">Y_subset</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="o">.</span><span class="n">device</span><span class="p">))</span>
            <span class="n">elbo</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">train_loss</span> <span class="o">+=</span> <span class="n">elbo</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">divergence_epoch_loss</span> <span class="o">+=</span> <span class="n">divergence_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">reconstruction_epoch_loss</span> <span class="o">+=</span> <span class="n">reconstruct_loss</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">categorical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">categorical_reconstruc</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">numerical_epoch_reconstruct</span> <span class="o">+=</span> <span class="n">numerical_reconstruct</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

            <span class="c1"># counter += 1</span>
            <span class="c1"># l2_norm = 0</span>
            <span class="c1"># for p in self.parameters():</span>
            <span class="c1">#     if p.requires_grad:</span>
            <span class="c1">#         p_norm = p.grad.detach().data.norm(2)</span>
            <span class="c1">#         l2_norm += p_norm.item() ** 2</span>
            <span class="c1"># l2_norm = l2_norm ** 0.5  # / Y_subset.shape[0]</span>
            <span class="c1"># mean_norm = (mean_norm * (counter - 1) + l2_norm) / counter</span>

        <span class="n">log_elbo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">train_loss</span><span class="p">)</span>
        <span class="n">log_reconstruct</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reconstruction_epoch_loss</span><span class="p">)</span>
        <span class="n">log_divergence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">divergence_epoch_loss</span><span class="p">)</span>
        <span class="n">log_cat_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">categorical_epoch_reconstruct</span><span class="p">)</span>
        <span class="n">log_num_loss</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">numerical_epoch_reconstruct</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">epoch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>

        <span class="k">if</span> <span class="n">train_loss</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min_elbo</span> <span class="o">-</span> <span class="n">delta</span><span class="p">):</span>

            <span class="n">min_elbo</span> <span class="o">=</span> <span class="n">train_loss</span>
            <span class="n">stop_counter</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Set counter to zero</span>
            <span class="k">if</span> <span class="n">filepath</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>  <span class="c1"># Save best model if we want to</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># elbo has not improved</span>

            <span class="n">stop_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">logging_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">Epoch: </span><span class="si">{</span><span class="n">epoch</span><span class="si">:</span><span class="s2">2</span><span class="si">}</span><span class="s2">. Elbo: </span><span class="si">{</span><span class="n">train_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Reconstruction Loss: </span><span class="si">{</span><span class="n">reconstruction_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. KL Divergence: </span><span class="si">{</span><span class="n">divergence_epoch_loss</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Categorical Loss: </span><span class="si">{</span><span class="n">categorical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">. Numerical Loss: </span><span class="si">{</span><span class="n">numerical_epoch_reconstruct</span><span class="si">:</span><span class="s2">11.2f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># print(f&quot;\tMean norm: {mean_norm}&quot;)</span>
        <span class="c1"># self.mean_norm = mean_norm</span>

        <span class="k">if</span> <span class="n">stop_counter</span> <span class="o">==</span> <span class="n">patience</span><span class="p">:</span>

            <span class="n">num_epochs</span> <span class="o">=</span> <span class="n">epoch</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">break</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">num_epochs</span><span class="p">,</span>
        <span class="n">log_elbo</span><span class="p">,</span>
        <span class="n">log_reconstruct</span><span class="p">,</span>
        <span class="n">log_divergence</span><span class="p">,</span>
        <span class="n">log_cat_loss</span><span class="p">,</span>
        <span class="n">log_num_loss</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div>
        </details>
    </div>

  </div>





  </div>

    </div>

  </div>







  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.model.io" class="doc doc-heading">
        <code>io</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.model.io.check_input_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_input_paths</span><span class="p">(</span><span class="n">fn_base</span><span class="p">,</span> <span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Sets up the input and output paths for the model files.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>fn_data</code></td>
        <td></td>
        <td><p>The name of the data file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_metadata</code></td>
        <td></td>
        <td><p>The name of the metadata file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>fn_metatransformer</code></td>
        <td><code>str</code></td>
        <td><p>The name of the metatransformer file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_experiment</code></td>
        <td><code>Path</code></td>
        <td><p>The path to the experiment directory.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>The paths to the data, metadata and metatransformer files.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/model/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_input_paths</span><span class="p">(</span><span class="n">fn_base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn_prepared</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn_metatransformer</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the input and output paths for the model files.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn_data: The name of the data file.</span>
<span class="sd">        fn_metadata: The name of the metadata file.</span>
<span class="sd">        fn_metatransformer: The name of the metatransformer file.</span>
<span class="sd">        dir_experiment: The path to the experiment directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The paths to the data, metadata and metatransformer files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn_base</span><span class="p">,</span> <span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_base</span><span class="p">),</span>
        <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_prepared</span><span class="p">),</span>
        <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_metatransformer</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_base</span><span class="p">),</span>
        <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_metatransformer</span><span class="p">,</span> <span class="n">fn_base</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">warn_if_path_supplied</span><span class="p">([</span><span class="n">fn_base</span><span class="p">,</span> <span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span><span class="p">],</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="n">check_exists</span><span class="p">([</span><span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span><span class="p">],</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn_base</span><span class="p">,</span> <span class="n">fn_prepared</span><span class="p">,</span> <span class="n">fn_metatransformer</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.model.io.check_output_paths" class="doc doc-heading">
<code class="highlight language-python"><span class="n">check_output_paths</span><span class="p">(</span><span class="n">fn_base</span><span class="p">,</span> <span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_model</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Sets up the input and output paths for the model files.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>fn_model</code></td>
        <td><code>str</code></td>
        <td><p>The name of the model file.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_experiment</code></td>
        <td><code>Path</code></td>
        <td><p>The path to the experiment output directory.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>The path to output the model.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/model/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">check_output_paths</span><span class="p">(</span><span class="n">fn_base</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">fn_out</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fn_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets up the input and output paths for the model files.</span>

<span class="sd">    Args:</span>
<span class="sd">        fn_model: The name of the model file.</span>
<span class="sd">        dir_experiment: The path to the experiment output directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The path to output the model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_model</span> <span class="o">=</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_out</span><span class="p">,</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span> <span class="n">consistent_ending</span><span class="p">(</span><span class="n">fn_model</span><span class="p">,</span> <span class="s2">&quot;.pt&quot;</span><span class="p">)</span>
    <span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_model</span> <span class="o">=</span> <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_base</span><span class="p">),</span> <span class="n">potential_suffix</span><span class="p">(</span><span class="n">fn_model</span><span class="p">,</span> <span class="n">fn_base</span><span class="p">)</span>
    <span class="n">warn_if_path_supplied</span><span class="p">([</span><span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_model</span><span class="p">],</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fn_out</span><span class="p">,</span> <span class="n">fn_model</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.model.io.load_required_data" class="doc doc-heading">
<code class="highlight language-python"><span class="n">load_required_data</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Loads the data from <code>args</code> or from disk when the dataloader has not be run previously.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>args</code></td>
        <td><code>Namespace</code></td>
        <td><p>The arguments passed to the module, in this case potentially carrying the outputs of the dataloader module.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>dir_experiment</code></td>
        <td><code>Path</code></td>
        <td><p>The path to the experiment directory.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>tuple</code></td>
      <td><p>The data, metadata and metatransformer.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>modules/model/io.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_required_data</span><span class="p">(</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">:</span> <span class="n">Path</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">MetaTransformer</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads the data from `args` or from disk when the dataloader has not be run previously.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: The arguments passed to the module, in this case potentially carrying the outputs of the dataloader module.</span>
<span class="sd">        dir_experiment: The path to the experiment directory.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The data, metadata and metatransformer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;dataloader_output&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">dataloader_output</span><span class="p">[</span><span class="s2">&quot;fn_real_data&quot;</span><span class="p">],</span>
            <span class="n">args</span><span class="o">.</span><span class="n">dataloader_output</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">],</span>
            <span class="n">args</span><span class="o">.</span><span class="n">dataloader_output</span><span class="p">[</span><span class="s2">&quot;metatransformer&quot;</span><span class="p">],</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">real_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;You must provide `--real-data` when running this module on its own, please provide this (a prepared version and corresponding MetaTransformer must also exist in </span><span class="si">{dir_experiment}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>
        <span class="n">fn_real_data</span><span class="p">,</span> <span class="n">fn_prepared_data</span><span class="p">,</span> <span class="n">fn_metatransformer</span> <span class="o">=</span> <span class="n">check_input_paths</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">real_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">prepared_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">real_metatransformer</span><span class="p">,</span> <span class="n">dir_experiment</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_prepared_data</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_metatransformer</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">metatransformer</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fn_real_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metatransformer</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>



  <div class="doc doc-object doc-module">



<h3 id="nhssynth.modules.model.run" class="doc doc-heading">
        <code>run</code>



</h3>

    <div class="doc doc-contents ">




  <div class="doc doc-children">








  <div class="doc doc-object doc-function">



<h4 id="nhssynth.modules.model.run.run" class="doc doc-heading">
<code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>


</h4>

    <div class="doc doc-contents ">

      <p>Run the model architecture module.</p>

        <details class="quote">
          <summary>Source code in <code>modules/model/run.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">args</span><span class="p">:</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">argparse</span><span class="o">.</span><span class="n">Namespace</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run the model architecture module.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Running model architecture module...&quot;</span><span class="p">)</span>

    <span class="n">set_seed</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span>

    <span class="n">dir_experiment</span> <span class="o">=</span> <span class="n">experiment_io</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

    <span class="n">fn_real_data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metatransformer</span> <span class="o">=</span> <span class="n">load_required_data</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="n">data</span><span class="p">,</span> <span class="n">categoricals</span><span class="p">,</span> <span class="n">num_continuous</span> <span class="o">=</span> <span class="n">metatransformer</span><span class="o">.</span><span class="n">order</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">torch_data</span> <span class="o">=</span> <span class="n">TensorDataset</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float32&quot;</span><span class="p">)))</span>

    <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">/</span> <span class="n">nrows</span>
    <span class="n">data_loader</span> <span class="o">=</span> <span class="n">DataLoader</span><span class="p">(</span>
        <span class="n">torch_data</span><span class="p">,</span>
        <span class="n">batch_sampler</span><span class="o">=</span><span class="n">UniformWithReplacementSampler</span><span class="p">(</span><span class="n">num_samples</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">),</span>
        <span class="n">pin_memory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Train, generate and evaluate </span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">args</span><span class="o">.</span><span class="n">non_private_training</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;DP&#39;</span><span class="si">}</span><span class="s2">VAE...&quot;</span><span class="p">)</span>

    <span class="n">encoder</span> <span class="o">=</span> <span class="n">Encoder</span><span class="p">(</span><span class="n">ncols</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span>
    <span class="n">decoder</span> <span class="o">=</span> <span class="n">Decoder</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">latent_dim</span><span class="p">,</span> <span class="n">num_continuous</span><span class="p">,</span> <span class="n">num_categories</span><span class="o">=</span><span class="n">categoricals</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">hidden_dim</span><span class="p">)</span>
    <span class="n">vae</span> <span class="o">=</span> <span class="n">VAE</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">decoder</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">non_private_training</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">diff_priv_train</span><span class="p">(</span>
            <span class="n">data_loader</span><span class="p">,</span>
            <span class="n">num_epochs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span>
            <span class="n">C</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_grad_norm</span><span class="p">,</span>
            <span class="n">target_epsilon</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">target_epsilon</span><span class="p">,</span>
            <span class="n">target_delta</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">target_delta</span><span class="p">,</span>
            <span class="n">sample_rate</span><span class="o">=</span><span class="n">sample_rate</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(epsilon, delta): </span><span class="si">{</span><span class="n">vae</span><span class="o">.</span><span class="n">get_privacy_spent</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">target_delta</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">data_loader</span><span class="p">,</span> <span class="n">num_epochs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">)</span>

    <span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">vae</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">nrows</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">synthetic_data</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>

    <span class="n">synthetic_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">synthetic_data</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span> <span class="n">columns</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">fn_output</span><span class="p">,</span> <span class="n">fn_model</span> <span class="o">=</span> <span class="n">check_output_paths</span><span class="p">(</span><span class="n">fn_real_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">synthetic_data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">model_file</span><span class="p">,</span> <span class="n">dir_experiment</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">discard_data</span><span class="p">:</span>
        <span class="c1"># synthetic_data = metatransformer.inverse_apply(synthetic_data)</span>
        <span class="n">synthetic_data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_output</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">discard_model</span><span class="p">:</span>
        <span class="n">vae</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dir_experiment</span> <span class="o">/</span> <span class="n">fn_model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">modules_to_run</span> <span class="ow">and</span> <span class="s2">&quot;evaluation&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">modules_to_run</span><span class="p">:</span>
        <span class="n">args</span><span class="o">.</span><span class="n">model_output</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">args</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>




  </div>

    </div>

  </div>






  </div>

    </div>

  </div>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">April 4, 2023</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Back to top
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../common/io/" class="md-footer__link md-footer__link--prev" aria-label="Previous: io" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                io
              </div>
            </div>
          </a>
        
        
          
          <a href="dataloader/" class="md-footer__link md-footer__link--next" aria-label="Next: dataloader" rel="next">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                dataloader
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "toc.integrate", "navigation.top", "search.suggest", "search.highlight", "search.share", "navigation.footer", "content.action.view", "content.action.edit"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.407015b8.min.js"></script>
      
    
  </body>
</html>